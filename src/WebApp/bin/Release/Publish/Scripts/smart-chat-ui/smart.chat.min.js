function ShowNewMessageAlert(){var n=$("li.chat-users > a > i");$(n).append('<em class="bg-color-pink flash animated">!<\/em>')}function HideNewMessageAlert(){var n=$("li.chat-users > a > i > em");n.length>0&&$(n).remove()}function registerEvents(n){var t=$("#show-shortcut  span").html();t.length>0&&n.server.connect(t);$("#btnClearChat").click(function(){var t=$("#chat-body > ul").html();t.length>0&&(n.server.clearTimeout(),$("#chat-body > ul").animateCss("slideOutRight",function(){$("#chat-body > ul > li").remove()}))});$("#btnSendMsg").click(function(){var t=$("#textarea-expand").val(),i,r;t.length>0&&(i=$("#show-shortcut  span").html(),r=GetCurrentDateTime(new Date),n.server.sendMessageToAll(i,t,r),$("#textarea-expand").val(""))});$("#textarea-expand").keypress(function(n){if(n.which==13&&$("#subscription").prop("checked"))return $("#btnSendMsg").click(),n.preventDefault(),!1})}function registerClientMethods(n){n.client.onConnected=function(t,r,u,f){for($("#hdId").val(t),$("#hdUserName").val(r),$("#spanUser").html(r),i=0;i<u.length;i++)$(".chat-users").length&&AddUser(n,u[i].ConnectionId,u[i].UserName,u[i].UserImage,u[i].LoginTime);for(i=0;i<f.length;i++)$("#chat-body").length&&AddMessage(f[i].UserName,f[i].Message,f[i].Time,f[i].UserImage)};n.client.onNewUserConnected=function(t,i,r,u){$(".chat-users").length&&AddUser(n,t,i,r,u)};n.client.onUserDisconnected=function(n){var t=$(".display-users dl").find('a[data-chat-id="'+n+'"]').parent();$(t).animate({opacity:"0"},200,function(){$(t).animate({height:"0px"},300,function(){$(t).remove()})})};n.client.messageReceived=function(n,t,i,r){var f,u;AddMessage(n,t,i,r);f=$("#hdUserName").val();f!=n&&(u=Math.round(moment().diff(moment(i,"YYYY-MM-DD HH:mm:ss"))/1e3),console.log("Display Message Count and Notification",i,u),$.smallBox({title:"有新消息",content:""+t+" 来至 【"+n+"】 <i class='fa fa-clock-o'><\/i> <i>"+u+" 秒前 .<\/i>",color:"#739E73",iconSmall:"fa fa-bell shake animated",number:"1",timeout:6e3}))};n.client.sendPrivateMessage=function(n,t,i,r,u,f,e){$(document).trigger("receivingprivatemessage",[{fromUserId:n,fromUserName:t,toUserId:i,toUserName:r,message:u,UserImg:f,CurrentDateTime:e}])}}function GetCurrentDateTime(n){return moment(n).format("MM-DD HH:mm")}function AddUser(n,t,i,r){var s=$("#hdId").val(),e=$(".display-users dl"),o="user",f="ME",u;s==t?(u=$('<dt class="animated fadeIn">  <a href="#" class="usr"     data-chat-id="'+t+'"     data-chat-fname="'+i+'"     data-chat-lname=" "     data-chat-status="online"     data-chat-alertmsg=" "     data-chat-alertshow="false"     rel="popover-hover"     data-placement="right"     data-html="true"     data-content="            <div class=\'usr-card\'>              <img src=\''+r+"' alt='"+f+"'>             <div class='usr-card-content'>             <h3>"+f+"<\/h3 >              <p>"+o+'<\/p>             <\/div>             <\/div>"             >         <i><\/i>'+f+"         <\/a>     <\/dt>     "),$(e).prepend(u)):(u=$('<dt class="animated fadeIn">  <a href="#" class="usr"     data-chat-id="'+t+'"     data-chat-fname="'+i+'"     data-chat-lname=" "     data-chat-status="online"     data-chat-alertmsg=" "     data-chat-alertshow="false"     rel="popover-hover"     data-placement="right"     data-html="true"     data-content="            <div class=\'usr-card\'>              <img src=\''+r+"' alt='"+i+"'>             <div class='usr-card-content'>             <h3>"+i+"<\/h3 >              <p>"+o+'<\/p>             <\/div>             <\/div>"             >         <i><\/i>'+i+"         <\/a>     <\/dt>     "),$(e).append(u),$("a[data-chat-id='"+t+"']:not(.offline)").click(function(n){var t=$(this),i=t.attr("data-chat-id"),r=t.attr("data-chat-fname"),u=t.attr("data-chat-lname"),f=t.attr("data-chat-status")||"online",e=t.attr("data-chat-alertmsg"),o=t.attr("data-chat-alertshow")||!1,s=$("#hdId").val();chatboxManager.addBox(i,{id:i,fromid:s,title:"username"+i,first_name:r,last_name:u,status:f,alertmsg:e,alertshow:o});n.preventDefault()}));$("a[rel=popover-hover]").popover({placement:"right",trigger:"hover"})}function AddMessage(n,t,i,r){var e=$("#hdUserName").val(),o="right",s="left",u,f;e==n&&(o="left",s="right");u='<li class="message" ><img   src="'+r+'" class="online" alt=""><div class="message-text"><time>'+i+'<\/time><a href="javascript:void(0);" class="username">'+n+"<\/a > "+t+"<\/div><\/li>";$("#chat-body > ul").append(u);f=$("#chat-body")[0].scrollHeight;$("#chat-body").slimScroll({scrollTo:f})}function ParseEmoji(n){$(n).emoticonize()}function uploadComplete(n,t){var i=$get("imgDisplay"),r;i.src="images/loading.gif";i.style.cssText="";r=new Image;r.onload=function(){i.style.cssText="Display:none;";i.src=r.src};i.src="<%# ResolveUrl(UploadFolderPath) %>"+t.get_fileName();var e=$.connection.chatHub,o=$("#hdUserName").val(),s=GetCurrentDateTime(new Date),u=(t.get_length()/1024).toFixed(2),f;IsValidateFile(t.get_fileName())&&(f=IsImageFile(t.get_fileName())?'<div class="box-body"><div class="attachment-block clearfix"><a><img id="imgC" style="width:100px;" class="attachment-img" src="'+i.src+'" alt="Attachment Image"><\/a><div class="attachment-pushed"> <h4 class="attachment-heading"><i class="fa fa-image">  '+t.get_fileName()+' <\/i><\/h4> <br /><div id="at" class="attachment-text"> Dimensions : '+i.height+"x"+i.width+", Type: "+t.get_contentType()+'<\/div><\/div><\/div><a id="btnDownload" href="'+i.src+'" class="btn btn-default btn-xs" download="'+t.get_fileName()+'"><i class="fa fa fa-download"><\/i> Download<\/a><button type="button" id="ShowModelImg"  value="'+i.src+'"  class="btn btn-default btn-xs"><i class="fa fa-camera"><\/i> View<\/button><span class="pull-right text-muted">File Size : '+u+" Kb<\/span><\/div>":'<div class="box-body"><div class="attachment-block clearfix"><a><img id="imgC" style="width:100px;" class="attachment-img" src="images/file-icon.png" alt="Attachment Image"><\/a><div class="attachment-pushed"> <h4 class="attachment-heading"><i class="fa fa-file-o">  '+t.get_fileName()+' <\/i><\/h4> <br /><div id="at" class="attachment-text"> Type: '+t.get_contentType()+'<\/div><\/div><\/div><a id="btnDownload" href="'+i.src+'" class="btn btn-default btn-xs" download="'+t.get_fileName()+'"><i class="fa fa fa-download"><\/i> Download<\/a><a href="'+i.src+'" target="_blank" class="btn btn-default btn-xs"><i class="fa fa-camera"><\/i> View<\/a><span class="pull-right text-muted">File Size : '+u+" Kb<\/span><\/div>",e.server.sendMessageToAll(o,f,s));i.src=""}function uploadStarted(){$get("imgDisplay").style.display="none"}function IsValidateFile(n){var t=[".doc",".docx",".pdf",".txt",".xlsx",".xls",".png",".jpg",".gif"],i=new RegExp("([a-zA-Z0-9s_\\.-:])+("+t.join("|")+")$");return i.test(n.toLowerCase())?!0:(alert("Please upload files having extensions: "+t.join(", ")+" only."),!1)}function IsImageFile(n){var t=new RegExp("(.png|.jpg|.gif)$");return t.test(n.toLowerCase())?!0:!1}var IntervalVal,chatboxManager;$(function(){var n=$.connection.chatHub;registerClientMethods(n);$.connection.hub.start().done(function(){registerEvents(n)});$(document).on("change","#uploadfilebutton",function(n){var t=URL.createObjectURL(n.target.files[0]);$("#ImgDisp").attr("src",t)});$(document).on("dispatchprivatemessage",function(t,i,r,u){n.server.sendPrivateMessage(i,u)})});$(document).on("click","#ShowModelImg",function(){$get("ImgModal").src=this.value;$("#ShowPictureModal").modal("show")});chatboxManager=function(){function e(){var n=$("li.chat-users > a > i");$(n).append('<em class="bg-color-pink flash animated">!<\/em>')}function o(){var n=$("li.chat-users > a > i > em");n.length>0&&$(n).remove()}var r=function(n){$.extend(chatbox_config,n)},u=function(){},n=function(){return(chatbox_config.width+chatbox_config.gap)*showList.length},f=function(n){var i=showList.indexOf(n),t;if(i!=-1)for(showList.splice(i,1),diff=chatbox_config.width+chatbox_config.gap,t=i;t<showList.length;t++)offset=$("#"+showList[t]).chatbox("option","offset"),$("#"+showList[t]).chatbox("option","offset",offset-diff);else alert("NOTE: Id missing from array: "+n)},t=function(t,r){var o=showList.indexOf(t),s=boxList.indexOf(t),e,u;o!=-1||(s!=-1?($("#"+t).chatbox("option","offset",n()),e=$("#"+t).chatbox("option","boxManager"),e.toggleBox(),showList.push(t)):(u=document.createElement("div"),u.setAttribute("id",t),$(u).chatbox({id:t,fromid:r.fromid,user:r,title:'<i title="'+r.status+'"><\/i>'+r.first_name+" "+r.last_name,hidden:!1,offset:n(),width:chatbox_config.width,status:r.status,alertmsg:r.alertmsg,alertshow:r.alertshow,messageSent:i,boxClosed:f}),boxList.push(t),showList.push(t),nameList.push(r.first_name)))},s=function(n,t,i,r){var u=boxList.indexOf(n);chatbox_config.messageSent(nameList[u],i,r)},i=function(n,t,i){var r=$("#hdId").val(),u=$("#hdUserName").val(),f={id:r,username:u};$("#"+n).chatbox("option","boxManager").addMsg("Me",i);$(document).trigger("dispatchprivatemessage",[n,t,i]);o()};$(document).on("receivingprivatemessage",function(n,i){var r=$("#hdId").val(),u=$("#hdUserName").val();r!=i.fromUserId&&(t(i.fromUserId,{id:i.fromUserId,fromid:i.toUserId,title:"username"+i.fromUserId,first_name:i.fromUserName,last_name:"",status:"online",alertmsg:"",alertshow:!1}),e(),$("#"+i.fromUserId).chatbox("option","boxManager").addMsg(i.fromUserName,i.message))});return{init:r,addBox:t,delBox:u,dispatch:i}}();$("a[data-chat-id]:not(.offline)").click(function(n){var t=$(this),i=t.attr("data-chat-id"),r=t.attr("data-chat-fname"),u=t.attr("data-chat-lname"),f=t.attr("data-chat-status")||"online",e=t.attr("data-chat-alertmsg"),o=t.attr("data-chat-alertshow")||!1,s=$("#hdId").val();chatboxManager.addBox(i,{id:i,fromid:s,title:"username"+i,first_name:r,last_name:u,status:f,alertmsg:e,alertshow:o});n.preventDefault()}),function(n){n.widget("ui.chatbox",{options:{id:null,fromid:null,title:null,user:null,hidden:!1,offset:0,width:300,status:"online",alertmsg:null,alertshow:null,messageSent:function(n,t,i,r){this.boxManager.addMsg(t.first_name,i,r)},boxClosed:function(){},boxManager:{init:function(n){this.elem=n},addMsg:function(t,i){var u=this,s=u.elem.uiChatboxLog,r=document.createElement("div"),h,f;if(n(r).addClass("ui-chatbox-msg"),s.append(r),n(r).hide(),h=!1,t){var e=document.createElement("div"),o=document.createElement("small"),c=document.createTextNode(moment().format("LT"));o.appendChild(c);o.className="chat-date";e.className="author-name";n(e).text(t+" ");e.appendChild(o);r.appendChild(e)}else h=!0;f=document.createElement("div");t=="Me"?(f.className="chat-message",n(r).addClass("right")):(f.className="chat-message active",n(r).addClass("left"));n(f).text(i);r.appendChild(f);n(r).css("maxWidth",n(s).width());n(r).fadeIn();n(r).find("span").emoticonize();u._scrollToBottom();u.elem.uiChatboxTitlebar.hasClass("ui-state-focus")||u.highlightLock||(u.highlightLock=!0,u.highlightBox())},highlightBox:function(){var n=this;n.elem.uiChatboxTitlebar.effect("highlight",{},300);n.elem.uiChatbox.effect("bounce",{times:2},300,function(){n.highlightLock=!1;n._scrollToBottom()})},toggleBox:function(){this.elem.uiChatbox.toggle()},_scrollToBottom:function(){var n=this.elem.uiChatboxLog;n.scrollTop(n.get(0).scrollHeight)}}},toggleContent:function(){this.uiChatboxContent.toggle();this.uiChatboxContent.is(":visible")&&this.uiChatboxInputBox.focus()},widget:function(){return this.uiChatbox},_create:function(){var t=this,o=t.options,h=o.title||"No Title",r=(t.uiChatbox=n("<div><\/div>")).appendTo(document.body).addClass("ui-widget ui-chatbox").attr("outline",0).attr("fromid",o.fromid).focusin(function(){t.uiChatboxTitlebar.addClass("ui-state-focus")}).focusout(function(){t.uiChatboxTitlebar.removeClass("ui-state-focus")}),i=(t.uiChatboxTitlebar=n("<div><\/div>")).addClass("ui-widget-header ui-chatbox-titlebar "+t.options.status+" ui-dialog-header").click(function(n){t.toggleContent(n)}).appendTo(r),l=(t.uiChatboxTitle=n("<span><\/span>")).html(h).appendTo(i),u=(t.uiChatboxTitlebarClose=n('<a href="#" rel="tooltip" data-placement="top" data-original-title="Hide"><\/a>')).addClass("ui-chatbox-icon ").attr("role","button").hover(function(){u.addClass("ui-state-hover")},function(){u.removeClass("ui-state-hover")}).click(function(){return r.hide(),t.options.boxClosed(t.options.id),!1}).appendTo(i),a=n("<i><\/i>").addClass("fa fa-times").appendTo(u),f=(t.uiChatboxTitlebarMinimize=n('<a href="#" rel="tooltip" data-placement="top" data-original-title="Minimize"><\/a>')).addClass("ui-chatbox-icon").attr("role","button").hover(function(){f.addClass("ui-state-hover")},function(){f.removeClass("ui-state-hover")}).click(function(n){return t.toggleContent(n),!1}).appendTo(i),v=n("<i><\/i>").addClass("fa fa-minus").appendTo(f),e=(t.uiChatboxContent=n('<div class="'+t.options.alertshow+'"><span class="alert-msg">'+t.options.alertmsg+"<\/span><\/div>")).addClass("ui-widget-content ui-chatbox-content ").appendTo(r),y=(t.uiChatboxLog=t.element).addClass("ui-widget-content ui-chatbox-log custom-scroll").appendTo(e),c=(t.uiChatboxInput=n("<div><\/div>")).addClass("ui-widget-content ui-chatbox-input").click(function(){}).appendTo(e),s=(t.uiChatboxInputBox=n("<textarea><\/textarea>")).addClass("ui-widget-content ui-chatbox-input-box ").appendTo(c).keydown(function(i){if(i.keyCode&&i.keyCode==n.ui.keyCode.ENTER)return msg=n.trim(n(this).val()),msg.length>0&&t.options.messageSent(t.options.id,t.options.user,msg,t.options.fromid),n(this).val(""),!1}).focusin(function(){s.addClass("ui-chatbox-input-focus");var t=n(this).parent().prev();t.scrollTop(t.get(0).scrollHeight)}).focusout(function(){s.removeClass("ui-chatbox-input-focus")});i.find("*").add(i).disableSelection();e.children().click(function(){t.uiChatboxInputBox.focus()});t._setWidth(t.options.width);t._position(t.options.offset);t.options.boxManager.init(t);t.options.hidden||r.show();n(".ui-chatbox [rel=tooltip]").tooltip()},_setOption:function(t,i){if(i!=null)switch(t){case"hidden":i?this.uiChatbox.hide():this.uiChatbox.show();break;case"offset":this._position(i);break;case"width":this._setWidth(i)}n.Widget.prototype._setOption.apply(this,arguments)},_setWidth:function(n){this.uiChatbox.width(n+28+"px");this.uiChatboxInputBox.css("width",n+18+"px")},_position:function(n){this.uiChatbox.css("right",n)}})}(jQuery),function(n){n.fn.emoticonize=function(t){for(var o,s,l,e=n.extend({},n.fn.emoticonize.defaults,t),u=[":-)",":o)",":c)",":^)",":-D",":-(",":-9",";-)",":-P",":-p",":-Þ",":-b",":-O",":-/",":-X",":-#",":'(","B-)","8-)",";*(",":-*",":-\\","?-)",": )",": ]","= ]","= )","8 )",": }",": D","8 D","X D","x D","= D",": (",": [",": {","= (","; )","; ]","; D",": P",": p","= P","= p",": b",": Þ",": O","8 O",": /","= /",": S",": #",": X","B )",": |",": \\","= \\",": *",": &gt;",": &lt;"],f=[":)",":]","=]","=)","8)",":}",":D",":(",":[",":{","=(",";)",";]",";D",":P",":p","=P","=p",":b",":Þ",":O",":/","=/",":S",":#",":X","B)",":|",":\\","=\\",":*",":&gt;",":&lt;"],r={"&gt;:)":{cssClass:"red-emoticon small-emoticon spaced-emoticon"},"&gt;;)":{cssClass:"red-emoticon small-emoticon spaced-emoticon"},"&gt;:(":{cssClass:"red-emoticon small-emoticon spaced-emoticon"},"&gt;: )":{cssClass:"red-emoticon small-emoticon"},"&gt;; )":{cssClass:"red-emoticon small-emoticon"},"&gt;: (":{cssClass:"red-emoticon small-emoticon"},";(":{cssClass:"red-emoticon spaced-emoticon"},"&lt;3":{cssClass:"pink-emoticon counter-rotated"},O_O:{cssClass:"no-rotate"},o_o:{cssClass:"no-rotate"},"0_o":{cssClass:"no-rotate"},O_o:{cssClass:"no-rotate"},T_T:{cssClass:"no-rotate"},"^_^":{cssClass:"no-rotate"},"O:)":{cssClass:"small-emoticon spaced-emoticon"},"O: )":{cssClass:"small-emoticon"},"8D":{cssClass:"small-emoticon spaced-emoticon"},XD:{cssClass:"small-emoticon spaced-emoticon"},xD:{cssClass:"small-emoticon spaced-emoticon"},"=D":{cssClass:"small-emoticon spaced-emoticon"},"8O":{cssClass:"small-emoticon spaced-emoticon"},"[+=..]":{cssClass:"no-rotate nintendo-controller"}},h=new RegExp("(\\)|\\(|\\*|\\[|\\]|\\{|\\}|\\||\\^|\\<|\\>|\\\\|\\?|\\+|\\=|\\.)","g"),c="(^|[\\s\\0])",i=u.length-1;i>=0;--i)u[i]=u[i].replace(h,"\\$1"),u[i]=new RegExp(c+"("+u[i]+")","g");for(i=f.length-1;i>=0;--i)f[i]=f[i].replace(h,"\\$1"),f[i]=new RegExp(c+"("+f[i]+")","g");for(o in r)r[o].regexp=o.replace(h,"\\$1"),r[o].regexp=new RegExp(c+"("+r[o].regexp+")","g");return s="span.css-emoticon",e.exclude&&(s+=","+e.exclude),l=s.split(","),this.not(s).each(function(){var t=n(this),i="css-emoticon",o;e.animate&&(i+=" un-transformed-emoticon animated-emoticon");for(o in r)specialCssClass=i+" "+r[o].cssClass,t.html(t.html().replace(r[o].regexp,"$1<span class='"+specialCssClass+"'>$2<\/span>"));n(u).each(function(){t.html(t.html().replace(this,"$1<span class='"+i+"'>$2<\/span>"))});n(f).each(function(){t.html(t.html().replace(this,"$1<span class='"+i+" spaced-emoticon'>$2<\/span>"))});n.each(l,function(i,r){t.find(n.trim(r)+" span.css-emoticon").each(function(){n(this).replaceWith(n(this).text())})});e.animate&&setTimeout(function(){n(".un-transformed-emoticon").removeClass("un-transformed-emoticon")},e.delay)})};n.fn.unemoticonize=function(t){var i=n.extend({},n.fn.emoticonize.defaults,t);return this.each(function(){var t=n(this);t.find("span.css-emoticon").each(function(){var t=n(this);i.animate?(t.addClass("un-transformed-emoticon"),setTimeout(function(){t.replaceWith(t.text())},i.delay)):t.replaceWith(t.text())})})};n.fn.emoticonize.defaults={animate:!0,delay:500,exclude:"pre,code,.no-emoticons"}}(jQuery);